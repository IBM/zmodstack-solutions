#
# Copyright 2023 IBM Inc. All rights reserved
# SPDX-License-Identifier: Apache2.0
#

---
- name: Initiallize SEAA framework
  ansible.builtin.include_tasks: "util/seaa_initialize.yml"

- name: Include Smart Deploy z/OS Cloud Broker task
  ansible.builtin.include_tasks: "util/smart_deploy_broker.yml"

- name: Manage SSHKey Secrets
  tags:
    - sshkey
  when:
    - hostvars[current_zosendpoint]._is_active
    - "'sshkey' in ansible_run_tags"
  ansible.builtin.include_role:
    name: openshift_cluster
    tasks_from: manage_secrets
  with_items:
    - "{{ groups['zosendpoints'] }}"
  loop_control:
    loop_var: current_zosendpoint

- name: Block to Manage ZPM Registry Secrets
  tags:
    - registry
  when:
    - "'registry' in ansible_run_tags"
    - zpm_sets_registry_config is defined and zpm_sets_registry_config
  block:

    # Include ansible variables for product sub-operator being installed
    - name: Include ZPM vars
      ansible.builtin.include_vars:
        file: "{{ zoscb_e2e_roles_directory }}/zpm/vars/main.yml"
      when: not zpm_vars_loaded

    - name: Set zpm_vars_loaded flag
      ansible.builtin.set_fact:
        zpm_vars_loaded: true
      when: not zpm_vars_loaded

    - name: Manage ZPM Registry Secrets
      when:
        - hostvars[current_zosendpoint]._is_active
      ansible.builtin.include_role:
        name: openshift_cluster
        tasks_from: manage_secrets
      vars:
        secret_type: "registry"
        registry: "{{ zos_package_manager.registries }}"
      with_items:
        - "{{ groups['zosendpoints'] }}"
      loop_control:
        loop_var: current_zosendpoint
